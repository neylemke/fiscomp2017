
/*
Efficient backend processing of iframe srcdoc's.

MOTIVATION: Sage jmol.
 */

(function() {
  var entity_map, misc, unescape;

  misc = require('smc-util/misc');

  exports.is_likely_iframe = function(content) {
    if (!content) {
      return;
    }
    content = content.slice(0, 50).trim().toLowerCase();
    return misc.startswith(content, '<iframe srcdoc="');
  };

  exports.process = function(content, blob_store) {
    var content_lower, i, j, src;
    content_lower = content.toLowerCase();
    i = content_lower.indexOf('<html>');
    j = content_lower.lastIndexOf('</html>');
    src = unescape(content.slice(i, j + '</html>'.length));
    return blob_store.save(src, 'text/html', content);
  };

  entity_map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
    '/': '&#x2F;',
    '`': '&#x60;',
    '=': '&#x3D;'
  };

  unescape = function(s) {
    var k, v;
    for (k in entity_map) {
      v = entity_map[k];
      s = misc.replace_all(s, v, k);
    }
    return s;
  };

}).call(this);
